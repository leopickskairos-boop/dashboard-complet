# ğŸ¯ Objectif
Modifier le systÃ¨me dâ€™inscription et de paiement pour quâ€™il nâ€™y ait **plus de paiement direct Ã  lâ€™inscription**.  
Ã€ la place, un **compte Ã  rebours de 30 jours** est lancÃ© dÃ¨s la crÃ©ation du compte, et **lâ€™administrateur** rattache ensuite manuellement chaque utilisateur Ã  un plan Stripe spÃ©cifique.

---

## âš™ï¸ Fonctionnement global Ã  implÃ©menter

### 1ï¸âƒ£ **Inscription**
- Lorsquâ€™un utilisateur sâ€™inscrit :
  - Aucun paiement Stripe nâ€™est dÃ©clenchÃ©.
  - Un `Stripe Customer` est **crÃ©Ã© immÃ©diatement** et reliÃ© Ã  son `userId`.
  - Les champs suivants doivent Ãªtre ajoutÃ©s Ã  la table `users` :
    ```js
    {
      id: Int,
      email: String,
      password: String,
      plan: String? (null par dÃ©faut),
      stripeCustomerId: String?,
      stripeSubscriptionId: String?,
      countdownStart: DateTime,
      countdownEnd: DateTime,
      accountStatus: "trial" | "active" | "expired"
    }
    ```
  - `countdownStart = now()`
  - `countdownEnd = now() + 30 days`
  - `accountStatus = "trial"`
  - `plan = null`

Exemple :
```js
await prisma.user.create({
  data: {
    email,
    password: hashedPassword,
    countdownStart: new Date(),
    countdownEnd: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
    accountStatus: "trial",
  },
});
```

---

### 2ï¸âƒ£ **Plans disponibles sur Stripe**

| Plan | Montant (â‚¬) | Price ID |
|------|--------------|----------|
| ğŸŸ© Basic | 400 | `price_1SRfP3442ACh1eI8PFt5z2b4` |
| ğŸŸ¨ Standard | 800 | *(dÃ©jÃ  existant)* |
| ğŸŸ¥ Premium | 1000 | `price_1SRfPE442ACh1eI8pzFhIJLH` |

â¡ï¸ Ces trois plans doivent Ãªtre dÃ©clarÃ©s dans un fichier `plans.js` :
```js
export const PLANS = {
  basic: "price_1SRfP3442ACh1eI8PFt5z2b4",
  standard: "price_XXXX800",
  premium: "price_1SRfPE442ACh1eI8pzFhIJLH",
};
```

---

### 3ï¸âƒ£ **RÃ´le de lâ€™Administrateur**
Depuis le **panneau dâ€™administration**, lâ€™admin doit pouvoir :
- Voir tous les utilisateurs ayant `accountStatus = "trial"`.
- Choisir un plan Stripe (400, 800, ou 1000).
- Rattacher ce plan Ã  lâ€™utilisateur manuellement.

Exemple :
```js
await prisma.user.update({
  where: { id: userId },
  data: { plan: "premium" },
});
```

âš ï¸ Ce rattachement ne dÃ©clenche **pas encore de paiement immÃ©diat.**
Il prÃ©pare simplement la future mensualisation.

---

### 4ï¸âƒ£ **Gestion automatique Ã  la fin du compte Ã  rebours**

- Tous les jours, un script (ou cron job) doit :
  - VÃ©rifier les utilisateurs dont `countdownEnd <= now()`.
  - Si un utilisateur **a un plan attachÃ©** (`plan != null`) :
    - CrÃ©er une **session Stripe Checkout** basÃ©e sur le `price_id` correspondant.
    - Envoyer automatiquement un **email de paiement** Ã  cet utilisateur (avec le lien de session).
  - Si un utilisateur **nâ€™a pas de plan attachÃ©** :
    - Son statut passe Ã  `expired`.
    - Lâ€™accÃ¨s au dashboard est bloquÃ© (redirection vers une page â€œAbonnement requisâ€).

Exemple logique :
```js
if (user.countdownEnd <= new Date()) {
  if (user.plan) {
    const session = await stripe.checkout.sessions.create({
      customer: user.stripeCustomerId,
      mode: "subscription",
      line_items: [{ price: PLANS[user.plan], quantity: 1 }],
      success_url: `${process.env.APP_URL}/dashboard?success=true`,
      cancel_url: `${process.env.APP_URL}/plans?cancelled=true`,
      metadata: { userId: user.id, plan: user.plan },
    });
    sendEmail(user.email, "Votre abonnement commence", session.url);
  } else {
    await prisma.user.update({
      where: { id: user.id },
      data: { accountStatus: "expired" },
    });
  }
}
```

---

### 5ï¸âƒ£ **AprÃ¨s paiement (Stripe webhook standard)**

Quand Stripe envoie `checkout.session.completed` :
```js
if (event.type === "checkout.session.completed") {
  const session = event.data.object;
  const userId = parseInt(session.metadata.userId);

  await prisma.user.update({
    where: { id: userId },
    data: {
      stripeSubscriptionId: session.subscription,
      accountStatus: "active",
    },
  });
}
```

â¡ï¸ Si lâ€™utilisateur paye â†’ `accountStatus = active`  
â¡ï¸ Sinon, il reste `expired`.

---

### 6ï¸âƒ£ **Ce quâ€™il faut ignorer / nettoyer**
- Tous les anciens utilisateurs actuellement â€œabonnÃ©sâ€ sont Ã  **ignorer ou supprimer** :
  > Ce sont des faux utilisateurs crÃ©Ã©s pour les tests, donc non pertinents.  
  > On repart de zÃ©ro avec cette nouvelle logique dâ€™inscription + countdown.

---

### 7ï¸âƒ£ **RÃ©sumÃ© du nouveau flux utilisateur**

```
[INSCRIPTION] (CrÃ©ation compte + Stripe Customer + countdownStart)
      â†“
[VÃ‰RIFICATION EMAIL]
      â†“
[ACCÃˆS DASHBOARD - pÃ©riode dâ€™essai 30 jours]
      â†“
[ADMIN ASSOCIE PLAN STRIPE Ã€ USERID]
      â†“
[FIN DU COUNTDOWN â†’ lien Stripe envoyÃ©]
      â†“
[PAIEMENT]
      â†“
[ACCOUNT STATUS = ACTIVE â†’ accÃ¨s complet]
```

---

### âœ… RÃ©sumÃ© opÃ©rationnel

| Ã‰tape | Action | Paiement ? | Statut |
|--------|---------|-------------|---------|
| 1. Inscription | CrÃ©ation compte + Stripe Customer | âŒ Non | trial |
| 2. Admin associe plan | Plan liÃ© (400, 800, 1000) | âŒ Non | trial |
| 3. Countdown fini | Stripe Checkout gÃ©nÃ©rÃ© | âš ï¸ Oui | pending |
| 4. Paiement effectuÃ© | Webhook Stripe | âœ… Oui | active |
| 5. Non-paiement | AccÃ¨s bloquÃ© | âŒ Non | expired |

---

## ğŸ” Environnement Ã  configurer dans Replit â†’ Secrets

```
STRIPE_SECRET_KEY=sk_live_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx
APP_URL=https://tonapp.repl.co
DATABASE_URL=postgresql://...
```

---

## ğŸ§  En rÃ©sumÃ©
- Suppression du paiement Ã  lâ€™inscription âœ…  
- Compte Ã  rebours de 30 jours aprÃ¨s crÃ©ation âœ…  
- Rattachement manuel du plan par admin âœ…  
- Paiement automatique Ã  la fin du dÃ©lai âœ…  
- Blocage des comptes non payÃ©s âœ…  
- RÃ©activation automatique aprÃ¨s paiement Stripe âœ…  
- Nettoyage des anciens â€œfaux comptes abonnÃ©sâ€ âœ…
