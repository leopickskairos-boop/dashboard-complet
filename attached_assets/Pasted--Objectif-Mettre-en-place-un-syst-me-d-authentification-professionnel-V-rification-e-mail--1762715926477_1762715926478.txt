# ğŸ”§ Objectif
Mettre en place un systÃ¨me dâ€™authentification professionnel :
- âœ… VÃ©rification e-mail UNIQUEMENT Ã  lâ€™inscription
- âœ… Connexion directe dÃ¨s que lâ€™email + mot de passe sont corrects
- ğŸš« Aucun mail automatique Ã  chaque connexion
- âœ‰ï¸ Mail dâ€™information seulement lors du changement de mot de passe (optionnel)

---

## âš™ï¸ Ã‰tape 1 â€” Fichier dâ€™authentification `[...nextauth].js`

Ouvre ou crÃ©e le fichier :
```
/pages/api/auth/[...nextauth].js
```

Et colle le code suivant :

```js
import CredentialsProvider from "next-auth/providers/credentials";
import { PrismaClient } from "@prisma/client";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

export const authOptions = {
  providers: [
    CredentialsProvider({
      name: "Connexion",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Mot de passe", type: "password" },
      },
      async authorize(credentials) {
        const user = await prisma.user.findUnique({
          where: { email: credentials.email },
        });

        if (!user) {
          throw new Error("Utilisateur non trouvÃ©.");
        }

        const validPassword = await bcrypt.compare(
          credentials.password,
          user.password
        );
        if (!validPassword) {
          throw new Error("Mot de passe incorrect.");
        }

        // VÃ©rifie que le mail a Ã©tÃ© validÃ© UNE SEULE FOIS Ã  lâ€™inscription
        if (!user.emailVerified) {
          throw new Error(
            "Veuillez vÃ©rifier votre adresse e-mail avant de vous connecter."
          );
        }

        // âœ… Connexion directe : aucune vÃ©rification par mail ici
        return user;
      },
    }),
  ],
  session: {
    strategy: "jwt",
  },
  pages: {
    signIn: "/login",
    newUser: "/register",
  },
};
```

---

## âš™ï¸ Ã‰tape 2 â€” Fichier dâ€™inscription (register.js)

Lorsquâ€™un nouvel utilisateur sâ€™inscrit :

```js
import bcrypt from "bcryptjs";
import { PrismaClient } from "@prisma/client";
import { sendVerificationEmail } from "@/lib/email"; // fonction Resend ou SMTP

const prisma = new PrismaClient();

export default async function register(req, res) {
  const { email, password } = req.body;

  const existingUser = await prisma.user.findUnique({ where: { email } });
  if (existingUser) return res.status(400).json({ error: "Email dÃ©jÃ  utilisÃ©" });

  const hashedPassword = await bcrypt.hash(password, 10);

  const user = await prisma.user.create({
    data: {
      email,
      password: hashedPassword,
      emailVerified: false,
    },
  });

  // Envoi du mail de vÃ©rification une seule fois
  await sendVerificationEmail(user.email);

  res.status(200).json({ message: "Compte crÃ©Ã©. VÃ©rifiez votre e-mail." });
}
```

---

## âš™ï¸ Ã‰tape 3 â€” Lors du clic sur le mail de vÃ©rification

Dans le lien contenu dans ton mail de vÃ©rification :
```
https://tonapp.repl.co/api/auth/verify?token=XYZ
```

Route `/api/auth/verify.js` :
```js
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export default async function verifyEmail(req, res) {
  const { email } = req.query;

  await prisma.user.update({
    where: { email },
    data: { emailVerified: true },
  });

  res.redirect("/login"); // redirige vers la page de connexion
}
```

---

## âš™ï¸ Ã‰tape 4 â€” (Optionnel) Envoi dâ€™un mail lors dâ€™un changement de mot de passe

Dans ton endpoint â€œupdate passwordâ€ :
```js
await resend.emails.send({
  from: "SpeedAI <no-reply@resend.dev>",
  to: user.email,
  subject: "Ton mot de passe a Ã©tÃ© modifiÃ© âœ…",
  html: "<p>Si tu n'es pas Ã  lâ€™origine de cette modification, contacte le support immÃ©diatement.</p>",
});
```

âš ï¸ Ce mail nâ€™empÃªche pas la connexion â€” il sert uniquement dâ€™information.

---

## ğŸ§© Ã‰tape 5 â€” Supprime ou dÃ©sactive EmailProvider
Dans ton ancien code :
```js
import EmailProvider from "next-auth/providers/email";
```
â¡ï¸ Supprime complÃ¨tement ce bloc.  
Câ€™est lui qui envoie les mails automatiques de connexion.

---

## âœ… RÃ©sumÃ©

| Action | RÃ©sultat |
|--------|-----------|
| ğŸ“© Inscription | Mail de vÃ©rification unique envoyÃ© |
| âœ… Connexion | Email + mot de passe â†’ accÃ¨s direct au dashboard |
| ğŸ” Changement de mot de passe | Mail dâ€™info (facultatif) |
| ğŸš« Email automatique Ã  chaque connexion | DÃ©sactivÃ© |
| ğŸ§± VÃ©rification email unique | GÃ©rÃ©e une seule fois Ã  lâ€™inscription |

---

## ğŸ§  RÃ©sultat attendu
- Ã€ lâ€™inscription : un seul mail de vÃ©rification  
- Ã€ la connexion : **connexion directe** (plus de mail de validation)
- AprÃ¨s connexion : **accÃ¨s immÃ©diat au dashboard**
- Si changement de mot de passe : simple mail dâ€™alerte (optionnel)
