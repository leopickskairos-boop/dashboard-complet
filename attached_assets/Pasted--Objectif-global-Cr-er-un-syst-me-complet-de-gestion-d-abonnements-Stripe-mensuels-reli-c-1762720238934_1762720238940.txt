# ğŸ¯ Objectif global
CrÃ©er un systÃ¨me complet de **gestion dâ€™abonnements Stripe mensuels** reliÃ© Ã  chaque utilisateur,
sans paiement Ã  lâ€™inscription, mais avec une **activation et un suivi par plan prÃ©cis**.

---

## ğŸ§© Fonctionnement gÃ©nÃ©ral

1ï¸âƒ£ **Inscription** â†’ Lâ€™utilisateur crÃ©e un compte sur lâ€™application (email + mot de passe).  
   - Aucun paiement Stripe Ã  cette Ã©tape.  
   - On stocke son `userId`, `email`, et on crÃ©e un `stripeCustomerId` automatiquement.  
   - Le champ `plan` est vide ou â€œpendingâ€.

2ï¸âƒ£ **Activation de lâ€™abonnement (par admin ou utilisateur)**  
   - Lâ€™admin choisit le plan (Ex : â€œProâ€, â€œBusinessâ€, â€œPremiumâ€).  
   - Chaque plan est reliÃ© Ã  un **price_id Stripe** (ex: `price_400MONTHLY`, `price_800MONTHLY`, `price_1000MONTHLY`).  
   - Le backend crÃ©e une session Stripe Checkout uniquement pour ce plan.  
   - Une fois payÃ©, Stripe dÃ©clenche un abonnement mensuel automatique.

3ï¸âƒ£ **Renouvellement**  
   - Stripe gÃ¨re les prÃ©lÃ¨vements automatiques.  
   - Chaque paiement mensuel envoie un webhook Ã  ton backend.  
   - Le backend met Ã  jour le statut de lâ€™abonnement dans la base (`paid`, `cancelled`, etc.).

4ï¸âƒ£ **Administration**  
   - Lâ€™interface admin permet de :
     - voir tous les utilisateurs et leurs abonnements actifs
     - modifier le plan ou le statut dâ€™un utilisateur
     - dÃ©clencher manuellement une session Stripe Checkout
     - suspendre ou rÃ©silier un abonnement

---

## âš™ï¸ Ce quâ€™il faut installer sur Replit

### ğŸ“¦ DÃ©pendances (dans package.json)
```bash
npm install stripe express body-parser cors bcryptjs prisma
```

---

## âš™ï¸ ClÃ©s et variables Ã  ajouter dans Replit â†’ Secrets

```
STRIPE_SECRET_KEY=sk_live_xxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx
APP_URL=https://tonapp.repl.co
DATABASE_URL=postgresql://...
```

---

## ğŸ§± Structure de la base de donnÃ©es (Prisma)

### Table `users`
```prisma
model User {
  id                    Int      @id @default(autoincrement())
  email                 String   @unique
  password              String
  plan                  String?
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  createdAt             DateTime @default(now())
  payments              Payment[]
}
```

### Table `payments`
```prisma
model Payment {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  plan       String
  status     String
  date       DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}
```

---

## ğŸ’³ Ã‰tape 1 â€” CrÃ©ation automatique du client Stripe Ã  lâ€™inscription

```js
import Stripe from "stripe";
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

app.post("/api/register", async (req, res) => {
  const { email, password } = req.body;

  const hashedPassword = await bcrypt.hash(password, 10);
  const user = await prisma.user.create({ data: { email, password: hashedPassword } });

  // CrÃ©ation du client Stripe
  const customer = await stripe.customers.create({
    email,
    metadata: { userId: user.id },
  });

  await prisma.user.update({
    where: { id: user.id },
    data: { stripeCustomerId: customer.id },
  });

  res.status(200).json({ message: "Utilisateur crÃ©Ã© avec succÃ¨s", user });
});
```

---

## ğŸ’³ Ã‰tape 2 â€” CrÃ©ation dâ€™une session Stripe Checkout (par admin ou utilisateur)

```js
app.post("/api/create-checkout-session", async (req, res) => {
  const { userId, plan, planPriceId } = req.body;
  const user = await prisma.user.findUnique({ where: { id: userId } });

  const session = await stripe.checkout.sessions.create({
    customer: user.stripeCustomerId,
    mode: "subscription",
    line_items: [{ price: planPriceId, quantity: 1 }],
    success_url: `${process.env.APP_URL}/dashboard?success=true`,
    cancel_url: `${process.env.APP_URL}/plans?cancelled=true`,
    metadata: { userId: user.id, plan },
  });

  res.json({ url: session.url });
});
```

---

## ğŸ” Ã‰tape 3 â€” Webhook Stripe (suivi des paiements)

```js
import bodyParser from "body-parser";
app.post("/api/stripe/webhook", bodyParser.raw({ type: "application/json" }), async (req, res) => {
  const sig = req.headers["stripe-signature"];

  let event;
  try {
    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    return res.status(400).send(`Webhook error: ${err.message}`);
  }

  if (event.type === "checkout.session.completed") {
    const session = event.data.object;
    const userId = parseInt(session.metadata.userId);
    const plan = session.metadata.plan;

    await prisma.user.update({
      where: { id: userId },
      data: {
        plan,
        stripeSubscriptionId: session.subscription,
      },
    });

    await prisma.payment.create({
      data: {
        userId,
        plan,
        amount: session.amount_total / 100,
        status: "paid",
      },
    });
  }

  if (event.type === "customer.subscription.deleted") {
    const subscription = event.data.object;
    await prisma.user.updateMany({
      where: { stripeSubscriptionId: subscription.id },
      data: { plan: "cancelled" },
    });
  }

  res.sendStatus(200);
});
```

---

## ğŸ§­ Ã‰tape 4 â€” Interface Admin Ã  prÃ©voir

### Dans le dashboard admin :
- Une table â€œUtilisateursâ€ avec :
  - Nom, email, plan actuel, statut abonnement, date de paiement
- Boutons :
  - â€œAssigner un planâ€ â†’ Ouvre une modale pour choisir un plan et crÃ©er la session Stripe
  - â€œRÃ©silier lâ€™abonnementâ€ â†’ Envoie une requÃªte Ã  Stripe pour stopper la facturation
  - â€œVoir paiementsâ€ â†’ Affiche la table `payments` de lâ€™utilisateur

---

## âœ… RÃ©sultat attendu

| Ã‰tape | RÃ©sultat |
|--------|----------|
| Inscription | CrÃ©e un utilisateur sans paiement |
| Activation plan | Lâ€™admin ou lâ€™utilisateur dÃ©clenche un paiement Stripe |
| Paiement | Lâ€™utilisateur est reliÃ© Ã  son abonnement |
| Renouvellement | Stripe gÃ¨re automatiquement |
| RÃ©siliation | Admin peut couper depuis dashboard |
| Historique | TraÃ§abilitÃ© complÃ¨te dans la base |

---

## ğŸ“‹ Ã€ ne pas oublier
- ğŸ” Toujours sÃ©curiser les routes admin avec `requireAdmin`
- ğŸ§¾ Tester les webhooks Stripe avec `stripe listen`
- âš™ï¸ Configurer les IDs produits (`price_xxxxx`) dans un fichier `plans.js`
- ğŸ“¦ Ajouter une route `GET /api/payments/:userId` pour afficher lâ€™historique

---

## ğŸ’¡ En rÃ©sumÃ©

| Ã‰lÃ©ment | RÃ´le |
|----------|------|
| Stripe Customer | CrÃ©Ã© automatiquement Ã  lâ€™inscription |
| Plan | AssignÃ© manuellement ou par admin |
| Session Checkout | DÃ©clenchÃ©e Ã  lâ€™activation |
| Webhook | Synchronise paiements et statuts |
| Base de donnÃ©es | Lie `userId` â†” `stripeSubscriptionId` |
| Dashboard Admin | Gestion et suivi complet |

