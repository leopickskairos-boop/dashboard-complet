# üîß PROMPT REPLIT - Workflow CB Valid√©e

---

## Contexte

J'ai cr√©√© un workflow N8N qui se d√©clenche quand un client valide sa carte bancaire (garantie CB). Ce workflow doit :
1. R√©cup√©rer les infos de la session + config client
2. Cr√©er l'√©v√©nement Google Calendar
3. Envoyer email + SMS de confirmation

J'ai besoin que tu cr√©es/modifies 2 choses dans le backend.

---

## 1. Cr√©er un endpoint pour r√©cup√©rer les d√©tails de session

### Endpoint

```
GET /api/guarantee/session-details/:sessionId
```

### Headers

```
Authorization: Bearer speedai_n8n_bdc161ffe627a1c7eeff9665a37ea0cb4e6d37de620c70c7be8baee458fefba0
```

(La cl√© API master N8N)

### R√©ponse attendue

```json
{
  "success": true,
  "sessionId": "abc123",
  "status": "validated",
  "customer": {
    "name": "Jean Dupont",
    "email": "jean@example.com",
    "phone": "+33612345678",
    "nbPersons": 4,
    "reservationDate": "2024-12-20",
    "reservationTime": "20:00",
    "reservationTimeEnd": "22:00"
  },
  "config": {
    "companyName": "Restaurant Le Gourmet",
    "companyAddress": "123 Rue de la Paix, 75001 Paris",
    "companyPhone": "01 23 45 67 89",
    "logoUrl": "https://exemple.com/logo.png",
    "brandColor": "#C8B88A",
    "penaltyAmount": 30,
    "cancellationDelay": 24,
    "gmailSenderName": "Restaurant Le Gourmet",
    "gmailSenderEmail": "contact@restaurant.fr",
    "calendarId": "abc123@group.calendar.google.com"
  },
  "penalty": {
    "amountPerPerson": 30,
    "totalAmount": 120,
    "currency": "EUR"
  }
}
```

### Notes

- `reservationTimeEnd` = reservationTime + 2 heures (ou dur√©e configur√©e)
- `calendarId` = l'ID du Google Calendar du client (si tu l'as en DB)
- Toutes les infos de config doivent venir de `guarantee_configs` + `users`

---

## 2. Appeler le webhook N8N apr√®s validation Stripe

### Quand ?

Quand le webhook Stripe re√ßoit l'√©v√©nement `checkout.session.completed` avec `mode: "setup"` (c'est une garantie CB).

### O√π modifier ?

Dans le handler du webhook Stripe, apr√®s avoir mis √† jour la session en "validated".

### Code √† ajouter

```javascript
// Dans le handler webhook Stripe
if (event.type === 'checkout.session.completed') {
  const session = event.data.object;
  
  // Seulement pour les sessions de garantie CB (mode setup)
  if (session.mode === 'setup') {
    
    // 1. Mettre √† jour la session en DB (d√©j√† fait normalement)
    const guaranteeSession = await storage.validateGuaranteeSession(
      session.id,
      {
        setupIntentId: session.setup_intent,
        customerStripeId: session.customer,
        paymentMethodId: session.payment_method
      }
    );
    
    // 2. Appeler N8N pour cr√©er Calendar + envoyer confirmations
    const N8N_WEBHOOK_URL = process.env.N8N_WEBHOOK_CB_VALIDEE;
    
    if (N8N_WEBHOOK_URL) {
      try {
        await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: guaranteeSession.id
          })
        });
        console.log('‚úÖ N8N webhook called for session:', guaranteeSession.id);
      } catch (error) {
        console.error('‚ùå Error calling N8N webhook:', error);
        // Ne pas faire √©chouer le webhook Stripe
      }
    }
  }
}
```

### Variable d'environnement √† ajouter

```
N8N_WEBHOOK_CB_VALIDEE=https://xxx.app.n8n.cloud/webhook/garantie-cb-validee
```

(Je te donnerai l'URL exacte apr√®s avoir activ√© le workflow N8N)

---

## 3. (Optionnel) Endpoint pour cr√©er l'√©v√©nement Calendar

Si tu pr√©f√®res que Replit cr√©e le Calendar directement plut√¥t que N8N, cr√©e cet endpoint :

```
POST /api/guarantee/create-calendar-event
Headers: Authorization: Bearer speedai_n8n_xxx
Body: {
  "sessionId": "abc123"
}
```

Cet endpoint :
1. R√©cup√®re la session + config
2. Utilise l'API Google Calendar du client
3. Cr√©e l'√©v√©nement
4. Retourne `{ success: true, eventId: "xxx" }`

Dis-moi si tu pr√©f√®res cette option, sinon N8N peut g√©rer le Calendar.

---

## R√©sum√©

| Action | Priorit√© |
|--------|----------|
| Cr√©er `GET /api/guarantee/session-details/:sessionId` | ‚úÖ Obligatoire |
| Appeler webhook N8N apr√®s validation Stripe | ‚úÖ Obligatoire |
| Ajouter variable `N8N_WEBHOOK_CB_VALIDEE` | ‚úÖ Obligatoire |
| Endpoint cr√©ation Calendar (optionnel) | ‚ö™ Si N8N ne g√®re pas le Calendar |

---

## Test

Apr√®s impl√©mentation, je pourrai tester avec :

```bash
# Test endpoint session-details
curl -X GET https://vocaledash.com/api/guarantee/session-details/SESSION_ID \
  -H "Authorization: Bearer speedai_n8n_bdc161ffe627a1c7eeff9665a37ea0cb4e6d37de620c70c7be8baee458fefba0"
```

Dis-moi quand c'est pr√™t !