# ğŸ” SYSTÃˆME GARANTIE CB - DOCUMENTATION COMPLÃˆTE

## Vue d'ensemble

Le systÃ¨me de garantie CB permet de sÃ©curiser les rÃ©servations en demandant au client d'enregistrer sa carte bancaire. Si le client ne vient pas (no-show), on peut dÃ©biter sa carte.

---

## ğŸ”„ ARCHITECTURE GLOBALE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WORKFLOW 1 : PRISE DE RDV                            â”‚
â”‚                         (N8N - Projet Prise de RDV)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Client appelle â†’ IA Retell collecte les infos                           â”‚
â”‚  2. N8N vÃ©rifie si garantie activÃ©e (GET /api/guarantee/status)             â”‚
â”‚  3. SI OUI â†’ N8N appelle SpeedAI (POST /api/n8n/guarantee/create-session)   â”‚
â”‚  4. N8N rÃ©pond Ã  l'IA : "Vous allez recevoir un lien pour valider"          â”‚
â”‚  5. FIN du workflow (pas de Wait)                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SPEEDAI                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. SpeedAI reÃ§oit la demande et stocke TOUTES les infos                    â”‚
â”‚  2. SpeedAI crÃ©e une session Stripe Checkout (mode setup)                   â”‚
â”‚  3. SpeedAI envoie EMAIL au client (lien validation CB)                     â”‚
â”‚  4. SpeedAI envoie SMS au client (lien validation CB)                       â”‚
â”‚  5. Client clique â†’ Page de validation CB                                   â”‚
â”‚  6. Client entre sa CB â†’ Stripe valide                                      â”‚
â”‚  7. SpeedAI reÃ§oit webhook Stripe "checkout.session.completed"              â”‚
â”‚  8. SpeedAI envoie EMAIL de confirmation                                    â”‚
â”‚  9. SpeedAI envoie SMS de confirmation                                      â”‚
â”‚  10. SpeedAI appelle N8N webhook CB ValidÃ©e avec TOUTES les infos           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WORKFLOW 2 : CB VALIDÃ‰E                                   â”‚
â”‚                    (N8N - Projet Retell)                                     â”‚
â”‚                                                                              â”‚
â”‚  URL WEBHOOK : https://djeydejy.app.n8n.cloud/webhook/garantie-nouvelle-resaâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. N8N reÃ§oit les donnÃ©es de SpeedAI                                       â”‚
â”‚  2. N8N crÃ©e le RDV dans Google Calendar                                    â”‚
â”‚  3. N8N envoie confirmation finale (si nÃ©cessaire)                          â”‚
â”‚  4. FIN                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## ğŸ“¡ ENDPOINT 1 : VÃ©rifier si garantie activÃ©e

### RequÃªte

```
GET /api/guarantee/status/:agent_id
```

### Exemple

```
GET /api/guarantee/status/agent_24572fd2ed314b65ce45b3240f
```

### RÃ©ponse

```json
{
  "guarantee_enabled": true
}
```

### Usage

N8N appelle cet endpoint AVANT de dÃ©cider s'il faut crÃ©er une session de garantie ou crÃ©er le RDV directement.

---

## ğŸ“¡ ENDPOINT 2 : CrÃ©er une session de garantie

### RequÃªte

```
POST /api/n8n/guarantee/create-session
Authorization: Bearer {dashboard_api_key}
Content-Type: application/json
```

### Body envoyÃ© par N8N

```json
{
  "agent_id": "agent_24572fd2ed314b65ce45b3240f",
  "customer_name": "Jean Dupont",
  "customer_email": "jean.dupont@email.com",
  "customer_phone": "+33612345678",
  "reservation_date": "15 janvier 2025",
  "reservation_time": "19:30",
  "nb_persons": 4,
  "calendar_id": "restaurant@gmail.com",
  "company_name": "Restaurant Chez Marcel",
  "company_email": "contact@chezmarcel.fr",
  "timezone": "Europe/Paris",
  "business_type": "restaurant",
  "vehicule": "",
  "type_service": "",
  "duration": 90
}
```

### Ce que SpeedAI doit faire

1. **Stocker TOUTES ces infos** dans la table `guarantee_sessions`
2. **CrÃ©er une session Stripe Checkout** (mode setup pour enregistrer la CB)
3. **Envoyer un EMAIL** au client avec le lien de validation
4. **Envoyer un SMS** au client avec le lien de validation
5. **Retourner** une rÃ©ponse Ã  N8N

### RÃ©ponse Ã  N8N

```json
{
  "success": true,
  "session_id": "cs_xxx",
  "validation_url": "https://vocal-dash-xxx.replit.app/validate/cs_xxx",
  "message": "Session crÃ©Ã©e, email et SMS envoyÃ©s"
}
```

### Structure table guarantee_sessions

```sql
guarantee_sessions (
  id UUID PRIMARY KEY,
  stripe_session_id VARCHAR,
  stripe_payment_method_id VARCHAR,
  
  -- Infos agent/business
  agent_id VARCHAR NOT NULL,
  business_type VARCHAR,
  
  -- Infos client
  customer_name VARCHAR NOT NULL,
  customer_email VARCHAR NOT NULL,
  customer_phone VARCHAR NOT NULL,
  
  -- Infos rÃ©servation
  reservation_date VARCHAR NOT NULL,
  reservation_time VARCHAR NOT NULL,
  nb_persons INTEGER,
  duration INTEGER,
  
  -- Infos pour crÃ©er le RDV aprÃ¨s validation
  calendar_id VARCHAR NOT NULL,
  company_name VARCHAR NOT NULL,
  company_email VARCHAR NOT NULL,
  timezone VARCHAR DEFAULT 'Europe/Paris',
  
  -- Garage spÃ©cifique
  vehicule VARCHAR,
  type_service VARCHAR,
  
  -- Status
  status VARCHAR DEFAULT 'pending',  -- pending, validated, expired, cancelled
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW(),
  validated_at TIMESTAMP,
  expires_at TIMESTAMP
)
```

---

## ğŸ“¡ WEBHOOK STRIPE : CB ValidÃ©e

### Quand Stripe envoie `checkout.session.completed`

SpeedAI doit :

1. **RÃ©cupÃ©rer la session** depuis la base de donnÃ©es
2. **Mettre Ã  jour le status** â†’ `validated`
3. **Envoyer EMAIL de confirmation** au client
4. **Envoyer SMS de confirmation** au client
5. **Appeler le webhook N8N** avec TOUTES les infos stockÃ©es

---

## ğŸ“¡ CALLBACK VERS N8N : AprÃ¨s validation CB

### URL Ã  appeler

```
POST https://djeydejy.app.n8n.cloud/webhook/garantie-nouvelle-resa
```

### Body Ã  envoyer

```json
{
  "status": "validated",
  "session_id": "cs_xxx",
  
  "agent_id": "agent_24572fd2ed314b65ce45b3240f",
  "business_type": "restaurant",
  
  "customer_name": "Jean Dupont",
  "customer_email": "jean.dupont@email.com",
  "customer_phone": "+33612345678",
  
  "reservation_date": "15 janvier 2025",
  "reservation_time": "19:30",
  "nb_persons": 4,
  "duration": 90,
  
  "calendar_id": "restaurant@gmail.com",
  "company_name": "Restaurant Chez Marcel",
  "company_email": "contact@chezmarcel.fr",
  "timezone": "Europe/Paris",
  
  "vehicule": "",
  "type_service": "",
  
  "validated_at": "2025-01-14T15:30:00Z"
}
```

### Important

N8N a besoin de TOUTES ces infos pour crÃ©er le RDV dans Google Calendar. SpeedAI doit donc :
- **Stocker** toutes les infos reÃ§ues lors de la crÃ©ation de session
- **Renvoyer** toutes ces infos lors du callback

---

## ğŸ“§ EMAILS Ã€ ENVOYER

### Email 1 : Demande de validation CB

**Quand :** AprÃ¨s crÃ©ation de la session (POST /api/n8n/guarantee/create-session)

**Sujet :** Confirmez votre rÃ©servation chez {company_name}

**Contenu :**
```
Bonjour {customer_name},

Votre demande de rÃ©servation a bien Ã©tÃ© enregistrÃ©e :

ğŸ“… Date : {reservation_date}
â° Heure : {reservation_time}
ğŸ‘¥ Personnes : {nb_persons}

Pour confirmer votre rÃ©servation, veuillez enregistrer votre carte bancaire 
en cliquant sur le lien ci-dessous :

[CONFIRMER MA RÃ‰SERVATION]

âš ï¸ Votre carte ne sera dÃ©bitÃ©e qu'en cas de non-prÃ©sentation (no-show).

Ã€ bientÃ´t !
L'Ã©quipe {company_name}
```

### Email 2 : Confirmation aprÃ¨s validation CB

**Quand :** AprÃ¨s que le client a validÃ© sa CB (webhook Stripe)

**Sujet :** âœ… RÃ©servation confirmÃ©e chez {company_name}

**Contenu :**
```
Bonjour {customer_name},

Votre rÃ©servation est confirmÃ©e ! ğŸ‰

ğŸ“… Date : {reservation_date}
â° Heure : {reservation_time}
ğŸ‘¥ Personnes : {nb_persons}
ğŸ“ Adresse : {company_address}

Nous avons hÃ¢te de vous accueillir !

Ã€ bientÃ´t,
L'Ã©quipe {company_name}
```

---

## ğŸ“± SMS Ã€ ENVOYER

### SMS 1 : Demande de validation CB

**Quand :** AprÃ¨s crÃ©ation de la session

**Contenu :**
```
{company_name} : Confirmez votre rÃ©servation du {reservation_date} Ã  {reservation_time} en enregistrant votre CB : {validation_url}
```

### SMS 2 : Confirmation aprÃ¨s validation CB

**Quand :** AprÃ¨s validation CB

**Contenu :**
```
âœ… {company_name} : RÃ©servation confirmÃ©e pour le {reservation_date} Ã  {reservation_time}. Ã€ bientÃ´t !
```

---

## ğŸ”§ VARIABLE D'ENVIRONNEMENT Ã€ CONFIGURER

```
N8N_WEBHOOK_CB_VALIDEE=https://djeydejy.app.n8n.cloud/webhook/garantie-nouvelle-resa
```

---

## ğŸ“‹ RÃ‰SUMÃ‰ DES ENDPOINTS SPEEDAI

| Endpoint | MÃ©thode | Usage |
|----------|---------|-------|
| `/api/guarantee/status/:agent_id` | GET | VÃ©rifier si garantie activÃ©e |
| `/api/n8n/guarantee/create-session` | POST | CrÃ©er session + envoyer liens |
| `/validate/:session_id` | GET | Page de validation CB (client) |
| Webhook Stripe | POST | Recevoir confirmation Stripe |

---

## ğŸ“‹ RÃ‰SUMÃ‰ DES ACTIONS SPEEDAI

| Ã‰tape | Action SpeedAI |
|-------|----------------|
| 1 | Recevoir demande de N8N |
| 2 | Stocker TOUTES les infos dans guarantee_sessions |
| 3 | CrÃ©er session Stripe Checkout |
| 4 | Envoyer EMAIL demande validation |
| 5 | Envoyer SMS demande validation |
| 6 | RÃ©pondre Ã  N8N (succÃ¨s) |
| 7 | Attendre validation client... |
| 8 | Recevoir webhook Stripe |
| 9 | Mettre Ã  jour status â†’ validated |
| 10 | Envoyer EMAIL confirmation |
| 11 | Envoyer SMS confirmation |
| 12 | Appeler webhook N8N avec TOUTES les infos |

---

## â“ QUESTIONS POUR REPLIT

1. L'endpoint `/api/n8n/guarantee/create-session` existe-t-il dÃ©jÃ  ? Si oui, est-ce qu'il stocke toutes les infos listÃ©es ci-dessus ?

2. L'endpoint `/api/guarantee/status/:agent_id` existe-t-il ?

3. Quand le webhook Stripe est reÃ§u, est-ce que SpeedAI appelle dÃ©jÃ  un webhook N8N ? Si oui, quelle URL et quelles donnÃ©es ?

4. Les emails et SMS de demande de validation sont-ils dÃ©jÃ  envoyÃ©s automatiquement ?

5. La table `guarantee_sessions` a-t-elle tous les champs nÃ©cessaires pour stocker les infos de rÃ©servation ?

Merci de confirmer ou de me dire ce qu'il faut ajouter/modifier ! ğŸš€