# âš™ï¸ Nouvelle logique dâ€™inscription et de facturation

Ce document explique le **nouveau fonctionnement du parcours utilisateur et du paiement mensuel** sur lâ€™application.  
Lâ€™objectif est de supprimer le paiement direct Ã  lâ€™inscription et dâ€™introduire une pÃ©riode dâ€™essai de 30 jours gÃ©rÃ©e par un **compte Ã  rebours automatique**.

---

## ğŸ” SchÃ©ma gÃ©nÃ©ral du processus

### 1ï¸âƒ£ **Inscription**
- Lâ€™utilisateur crÃ©e un compte avec son email et son mot de passe.
- Aucun paiement Stripe nâ€™est lancÃ© Ã  cette Ã©tape.
- Lors de la crÃ©ation du compte :
  - un **Stripe Customer** est automatiquement crÃ©Ã© (liÃ© Ã  `userId`)
  - le compte utilisateur est ajoutÃ© dans la base de donnÃ©es avec les champs suivants :
    - `stripeCustomerId`
    - `plan` = `null`
    - `countdownStart` = date du jour
    - `countdownEnd` = `date du jour + 30 jours`
    - `accountStatus` = `trial` (essai)

---

### 2ï¸âƒ£ **VÃ©rification de lâ€™e-mail**
- Lâ€™utilisateur reÃ§oit un e-mail de vÃ©rification classique.
- Une fois vÃ©rifiÃ©, il accÃ¨de immÃ©diatement au **dashboard**.
- Aucun paiement nâ€™est encore demandÃ©.

---

### 3ï¸âƒ£ **PÃ©riode dâ€™essai (compte Ã  rebours de 30 jours)**
- DÃ¨s la vÃ©rification, un **compte Ã  rebours de 30 jours** dÃ©marre automatiquement.
- Ce dÃ©lai est affichÃ© dans le dashboard utilisateur (ex: â€œ28 jours restants sur votre pÃ©riode dâ€™essaiâ€).
- Lâ€™utilisateur peut utiliser toutes les fonctionnalitÃ©s comme un utilisateur normal.
- **Pendant ce temps**, aucune facturation nâ€™est dÃ©clenchÃ©e cÃ´tÃ© Stripe.

---

### 4ï¸âƒ£ **Intervention de lâ€™ADMIN pendant la pÃ©riode dâ€™essai**
- Depuis le **panneau dâ€™administration**, lâ€™ADMIN peut :
  - Voir tous les utilisateurs en pÃ©riode dâ€™essai et leur date dâ€™expiration.
  - Choisir un plan pour chaque utilisateur :
    - ğŸŸ© Plan 400â‚¬ â†’ `price_400MONTHLY`
    - ğŸŸ¨ Plan 800â‚¬ â†’ `price_800MONTHLY`
    - ğŸŸ¥ Plan 1000â‚¬ â†’ `price_1000MONTHLY`
  - **Associer manuellement le `userId` au produit Stripe** correspondant.
- Cette association ne dÃ©clenche **pas encore de paiement immÃ©diat.**
- Elle sert Ã  **prÃ©parer la mensualisation future.**

---

### 5ï¸âƒ£ **Fin du compte Ã  rebours (dÃ©but de la mensualisation)**
- Une fois le compte Ã  rebours terminÃ© :
  - Le backend dÃ©tecte que `countdownEnd < now()`.
  - Si lâ€™utilisateur a Ã©tÃ© associÃ© Ã  un plan Stripe :
    - Une **session de paiement Stripe Checkout** est automatiquement gÃ©nÃ©rÃ©e.
    - Lâ€™utilisateur reÃ§oit un **lien de paiement par e-mail**.
    - DÃ¨s quâ€™il paye, son statut passe Ã  :
      - `accountStatus` = `active`
      - `plan` = plan choisi
      - `stripeSubscriptionId` = abonnement crÃ©Ã©
  - Si lâ€™utilisateur **nâ€™a pas encore payÃ©**, son accÃ¨s au dashboard est bloquÃ© :
    - `accountStatus` = `expired`
    - Redirection vers une page â€œAbonnement requisâ€

---

### 6ï¸âƒ£ **AprÃ¨s paiement**
- Une fois le premier paiement effectuÃ© :
  - Stripe gÃ¨re automatiquement les **renouvellements mensuels**.
  - Le webhook Stripe met Ã  jour le statut de lâ€™utilisateur (`active`, `cancelled`, etc.)
  - Lâ€™utilisateur garde lâ€™accÃ¨s complet au dashboard.

---

## ğŸ§¾ En rÃ©sumÃ© logique

| Ã‰tape | Action | Paiement ? | Statut compte |
|--------|--------|-------------|---------------|
| 1. Inscription | CrÃ©ation compte + Stripe Customer | âŒ Non | trial (essai) |
| 2. VÃ©rif email | Validation compte | âŒ Non | trial |
| 3. Compte Ã  rebours | Utilisation libre 30 jours | âŒ Non | trial |
| 4. Admin choisit plan | Lien `userId` â†” `price_id` | âŒ Non | trial |
| 5. Fin du dÃ©lai | Stripe Checkout dÃ©clenchÃ© | âœ… Oui | active / expired |
| 6. Paiement rÃ©ussi | Abonnement actif mensuel | âœ… Oui | active |
| 7. Non-paiement | AccÃ¨s bloquÃ© | âŒ Oui | expired |

---

## âš¡ï¸ Points techniques Ã  prÃ©voir plus tard

- Un **cron job quotidien** (ou un script planifiÃ©) pour :
  - vÃ©rifier tous les `countdownEnd`
  - dÃ©clencher les paiements automatiques pour ceux qui ont un plan liÃ©
  - dÃ©sactiver les comptes dont le dÃ©lai est expirÃ© sans paiement

- Une **table â€œtrialCountdownâ€** ou champs intÃ©grÃ©s Ã  `users` :
  ```js
  {
    id: 12,
    email: "client@exemple.com",
    plan: null,
    countdownStart: "2025-11-09",
    countdownEnd: "2025-12-09",
    accountStatus: "trial"
  }
  ```

- Un **champ â€œisLinkedToPlanâ€** boolÃ©en pour savoir si lâ€™admin a reliÃ© un plan Stripe au compte.

---

## ğŸ¯ Objectif de cette nouvelle logique
- Supprimer toute friction Ã  lâ€™inscription : aucun paiement immÃ©diat.  
- Laisser une **pÃ©riode dâ€™essai claire de 30 jours** pour tester.  
- Permettre Ã  lâ€™admin de gÃ©rer finement le moment du paiement.  
- Assurer une transition fluide vers la mensualisation Stripe.  
- Bloquer proprement les comptes expirÃ©s sans paiement.

---

## âœ… Ce qui ne change pas
- Authentification via email + mot de passe.  
- VÃ©rification email unique Ã  lâ€™inscription.  
- Connexion directe aprÃ¨s validation.  
- Dashboard et statistiques identiques aprÃ¨s paiement.  
- Webhook Stripe pour gÃ©rer le renouvellement mensuel automatique.

---

### ğŸ§© Exemple visuel du flux utilisateur :

```
[INSCRIPTION] â†’ [VÃ‰RIF EMAIL] â†’ [TRIAL 30J] â†’ [ADMIN ASSOCIE PLAN] 
â†’ [Ã‰CHÃ‰ANCE] â†’ [PAIEMENT STRIPE CHECKOUT] â†’ [ABONNEMENT ACTIF] â†’ [DASHBOARD]
```
