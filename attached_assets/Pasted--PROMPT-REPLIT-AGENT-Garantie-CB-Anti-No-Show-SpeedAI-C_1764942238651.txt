# üõ°Ô∏è PROMPT REPLIT AGENT - Garantie CB Anti No-Show SpeedAI

---

## CONTEXTE

Je d√©veloppe SpeedAI, un service d'IA r√©ceptionniste pour restaurants/garages/kin√©s. J'ai besoin d'ajouter une fonctionnalit√© de **garantie par carte bancaire** pour r√©duire les no-shows.

**Principe :**
- Quand un client r√©serve par t√©l√©phone (via Retell AI), on lui demande d'enregistrer sa CB
- Empreinte √† 0‚Ç¨ (aucun d√©bit imm√©diat)
- La r√©servation reste "en attente" tant que la CB n'est pas valid√©e
- Si le client ne vient pas (no-show), on d√©bite automatiquement une p√©nalit√©
- Chaque client SpeedAI (restaurant, garage, etc.) a sa propre config

**Stack existante :**
- Backend : Node.js/Express sur Replit
- Base de donn√©es : Neon PostgreSQL
- Frontend dashboard : React
- Paiement : Stripe Connect (chaque client a son propre compte Stripe)
- Workflows : N8N (g√©r√© s√©par√©ment, tu n'as pas √† t'en occuper)

---

## CE QUE TU DOIS CR√âER

### 1. TABLES BASE DE DONN√âES (Neon PostgreSQL)

Cr√©e ces 3 tables :

```sql
-- Table de configuration garantie CB par client
CREATE TABLE IF NOT EXISTS client_guarantee_config (
  id SERIAL PRIMARY KEY,
  client_id INTEGER REFERENCES clients(id) UNIQUE,
  
  -- Activation
  enabled BOOLEAN DEFAULT FALSE,
  
  -- Stripe Connect
  payment_provider VARCHAR(20) DEFAULT 'stripe',
  stripe_account_id VARCHAR(50),
  
  -- Param√®tres p√©nalit√©
  penalty_amount INTEGER DEFAULT 30,
  cancellation_delay INTEGER DEFAULT 24,
  
  -- Conditions d'application
  apply_to VARCHAR(20) DEFAULT 'all',
  min_persons INTEGER DEFAULT 1,
  
  -- Branding page client
  logo_url VARCHAR(255),
  brand_color VARCHAR(7) DEFAULT '#6366f1',
  
  -- Email exp√©diteur
  gmail_sender_email VARCHAR(100),
  gmail_sender_name VARCHAR(100),
  
  -- CGV
  terms_url VARCHAR(255),
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des sessions de garantie CB
CREATE TABLE IF NOT EXISTS guarantee_sessions (
  id SERIAL PRIMARY KEY,
  client_id INTEGER REFERENCES clients(id),
  reservation_id VARCHAR(50) UNIQUE,
  
  -- Infos client final
  customer_name VARCHAR(100),
  customer_email VARCHAR(100),
  customer_phone VARCHAR(20),
  nb_persons INTEGER,
  reservation_date TIMESTAMP,
  
  -- Stripe
  payment_provider VARCHAR(20) DEFAULT 'stripe',
  checkout_session_id VARCHAR(100),
  setup_intent_id VARCHAR(100),
  payment_method_id VARCHAR(100),
  customer_stripe_id VARCHAR(50),
  
  -- Statuts : pending, validated, completed, cancelled, noshow_charged, noshow_failed
  status VARCHAR(20) DEFAULT 'pending',
  
  -- Montants
  penalty_amount INTEGER,
  charged_amount INTEGER,
  
  -- Dates
  created_at TIMESTAMP DEFAULT NOW(),
  validated_at TIMESTAMP,
  charged_at TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- Relances
  reminder_count INTEGER DEFAULT 0,
  last_reminder_at TIMESTAMP
);

-- Table des d√©bits no-show
CREATE TABLE IF NOT EXISTS noshow_charges (
  id SERIAL PRIMARY KEY,
  guarantee_session_id INTEGER REFERENCES guarantee_sessions(id),
  client_id INTEGER REFERENCES clients(id),
  
  payment_intent_id VARCHAR(100),
  amount INTEGER,
  currency VARCHAR(3) DEFAULT 'eur',
  status VARCHAR(20),
  failure_reason VARCHAR(255),
  
  disputed BOOLEAN DEFAULT FALSE,
  dispute_reason VARCHAR(255),
  
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index pour performances
CREATE INDEX IF NOT EXISTS idx_guarantee_sessions_client_id ON guarantee_sessions(client_id);
CREATE INDEX IF NOT EXISTS idx_guarantee_sessions_status ON guarantee_sessions(status);
CREATE INDEX IF NOT EXISTS idx_guarantee_sessions_reservation_date ON guarantee_sessions(reservation_date);
CREATE INDEX IF NOT EXISTS idx_guarantee_sessions_checkout_session ON guarantee_sessions(checkout_session_id);
```

---

### 2. API ENDPOINTS (Express.js)

Cr√©e un fichier `routes/guarantee.js` avec ces endpoints :

#### Configuration

**GET /api/config/guarantee/:clientId**
- R√©cup√®re la config garantie d'un client
- Join avec table `clients` pour avoir company_name, address, phone
- Retourne aussi `stripe_connected: true/false` bas√© sur stripe_account_id

**PUT /api/config/guarantee/:clientId**
- Met √† jour la config (enabled, penalty_amount, cancellation_delay, apply_to, min_persons, logo_url, brand_color, gmail_sender_email, gmail_sender_name, terms_url)
- Utilise UPSERT (INSERT ... ON CONFLICT DO UPDATE)

#### Stripe Connect

**POST /api/guarantee/connect-stripe**
- Body: `{ client_id }`
- Cr√©e un compte Stripe Connect Standard si pas existant
- G√©n√®re un lien d'onboarding Stripe
- Sauvegarde stripe_account_id en DB
- Retourne `{ url: "https://connect.stripe.com/..." }`

**POST /api/guarantee/disconnect-stripe/:clientId**
- Met stripe_account_id √† NULL
- Met enabled √† false

**GET /api/guarantee/stripe-status/:clientId**
- V√©rifie si le compte Stripe est pr√™t (charges_enabled)
- Retourne `{ connected, details_submitted, payouts_enabled }`

#### Sessions (appel√©s par N8N)

**POST /api/guarantee/create-session**
- Body: `{ client_id, reservation_id, customer_name, customer_email, customer_phone, nb_persons, reservation_date, reservation_time }`
- R√©cup√®re config client (stripe_account_id, penalty_amount)
- Cr√©e Stripe Checkout Session en mode "setup" sur le compte connect√©
- Sauvegarde en DB avec status "pending"
- Retourne `{ checkout_url, session_id }`

**GET /api/guarantee/session-by-checkout/:checkoutSessionId**
- R√©cup√®re une session par son checkout_session_id
- Join avec clients et config pour avoir toutes les infos
- Utilis√© par N8N apr√®s webhook Stripe

**PATCH /api/guarantee/validate-session**
- Body: `{ checkout_session_id, setup_intent_id, customer_stripe_id }`
- Met √† jour la session : status = "validated", validated_at = NOW()
- Sauvegarde setup_intent_id et customer_stripe_id

#### R√©servations

**GET /api/guarantee/reservations/:clientId**
- Query params: `period` (today, week, month)
- Retourne 3 listes :
  - `pending`: status = 'pending'
  - `validated`: status = 'validated'
  - `today`: status = 'validated' ET date = aujourd'hui

**POST /api/reservations/:reservationId/status**
- Body: `{ status }` ('attended' ou 'noshow')
- Si 'attended': update status = 'completed'
- Si 'noshow':
  1. R√©cup√©rer setup_intent_id et stripe_account_id
  2. R√©cup√©rer payment_method depuis Stripe
  3. Cr√©er PaymentIntent off_session sur compte connect√©
  4. Montant = penalty_amount √ó nb_persons √ó 100 (centimes)
  5. Si succ√®s: status = 'noshow_charged', log dans noshow_charges
  6. Si √©chec: status = 'noshow_failed', log erreur
- Retourne `{ success, charged }` ou `{ success: false, error }`

**POST /api/guarantee/resend/:reservationId**
- Cr√©e une nouvelle Stripe Checkout Session
- Met √† jour checkout_session_id en DB
- Incr√©mente reminder_count
- Retourne `{ success, checkout_url }`

**POST /api/guarantee/cancel/:reservationId**
- Met status = 'cancelled'

#### Stats & Historique

**GET /api/guarantee/stats/:clientId**
- Query params: `period` (week, month, year, all)
- Retourne :
  - `noshow_count`: nombre de no-shows
  - `total_recovered`: somme des charged_amount
  - `failed_charges`: nombre d'√©checs de d√©bit
  - `total_avoided`: estimation (annulations apr√®s validation √ó penalty moyen)

**GET /api/guarantee/history/:clientId**
- Query params: `period`
- Retourne liste des no-shows avec statut du d√©bit

#### Endpoints publics (page client final)

**GET /api/guarantee/public/session/:sessionId**
- R√©cup√®re infos session pour affichage page publique
- Pas besoin d'auth
- Retourne: status, customer_name, nb_persons, reservation_date, penalty_amount, cancellation_delay, logo_url, brand_color, company_name, address, phone

**POST /api/guarantee/public/checkout/:sessionId**
- R√©cup√®re l'URL Stripe Checkout de la session
- Retourne `{ checkout_url }`

#### Webhook Stripe

**POST /api/webhooks/stripe**
- Middleware: express.raw() pour signature
- V√©rifier signature avec STRIPE_WEBHOOK_SECRET
- Events √† g√©rer:
  - `checkout.session.completed` (mode setup): mettre √† jour session validated
  - `account.updated`: v√©rifier si charges_enabled

---

### 3. COMPOSANTS REACT DASHBOARD

#### GuaranteeSettings.jsx
Page de configuration avec sections d√©pliables :
- Toggle ON/OFF en haut
- Section "Compte Stripe" : bouton connecter/d√©connecter, statut
- Section "Montant p√©nalit√©" : input ‚Ç¨/personne
- Section "D√©lai annulation" : input heures
- Section "Conditions" : radio buttons (toutes r√©sas / min X personnes / weekend)
- Section "Personnalisation" : upload logo, color picker
- Section "Email exp√©diteur" : inputs email et nom
- Boutons "Voir aper√ßu email" et "Voir page CB"

Design moderne avec :
- Sections en accord√©on (une ouverte √† la fois)
- Ic√¥nes color√©es pour chaque section
- Toggle switch anim√©
- Indicateur de sauvegarde en bas √† droite

#### GuaranteeReservations.jsx
Liste des r√©servations avec garantie :
- Header avec filtres (p√©riode, statut)
- Stats bar : En attente, Valid√©es, Aujourd'hui, Taux validation
- Section "Aujourd'hui" avec boutons [Venu] [No-show] pour chaque r√©sa
- Section "En attente" avec boutons [Renvoyer lien] [Annuler]
- Section "Valid√©es" (lecture seule)

Chaque r√©servation affiche :
- Ic√¥ne statut
- Nom client
- Nb personnes, t√©l√©phone
- Date/heure
- Temps √©coul√© depuis cr√©ation

#### GuaranteeHistory.jsx
Historique des no-shows :
- Stats cards : R√©cup√©r√©s (‚Ç¨), No-shows, √âvit√©s (‚Ç¨)
- Tableau avec : Date, Client, Personnes, Montant, Statut
- Bouton "Relancer" pour les d√©bits √©chou√©s
- Filtre par p√©riode

#### GuaranteePage.jsx
Page publique pour le client final (brand√©e) :
- Logo du restaurant
- Titre "Finalisez votre r√©servation"
- Card r√©cap : date, heure, nb personnes
- Badge vert "Aucun montant d√©bit√©"
- Bouton CTA color√© "Confirmer ma r√©servation"
- Conditions d'annulation (fond jaune)
- Footer s√©curit√© (Stripe)
- Footer restaurant (adresse, tel)
- √âtats : loading, error, already_validated

---

### 4. VARIABLES D'ENVIRONNEMENT

Ajoute ces variables :

```env
# Stripe
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# URLs
DASHBOARD_URL=https://ton-dashboard.replit.app
PUBLIC_URL=https://ton-app.replit.app
```

---

### 5. INT√âGRATION STRIPE CONNECT

Configuration Stripe :
- Type de compte : Standard
- Pays : France
- MCC : 5812 (Restaurants)

Pour cr√©er une session Checkout sur un compte connect√© :
```javascript
const session = await stripe.checkout.sessions.create({
  mode: 'setup',
  payment_method_types: ['card'],
  customer_email: email,
  success_url: `${PUBLIC_URL}/guarantee/confirmation?session_id={CHECKOUT_SESSION_ID}`,
  cancel_url: `${PUBLIC_URL}/guarantee/annulation`,
  metadata: { client_id, reservation_id, customer_name, nb_persons }
}, {
  stripeAccount: stripe_account_id  // <-- Compte du restaurant
});
```

Pour d√©biter apr√®s no-show :
```javascript
const paymentIntent = await stripe.paymentIntents.create({
  amount: montant_centimes,
  currency: 'eur',
  customer: customer_stripe_id,
  payment_method: payment_method_id,
  confirm: true,
  off_session: true,
  description: `P√©nalit√© no-show - R√©servation du ${date}`
}, {
  stripeAccount: stripe_account_id
});
```

---

### 6. ROUTES REACT √Ä AJOUTER

```jsx
<Route path="/settings/guarantee" element={<GuaranteeSettings clientId={clientId} />} />
<Route path="/reservations/guarantee" element={<GuaranteeReservations clientId={clientId} />} />
<Route path="/history/noshow" element={<GuaranteeHistory clientId={clientId} />} />

// Route publique (sans auth)
<Route path="/g/:sessionId" element={<GuaranteePage />} />
```

---

### 7. POINTS IMPORTANTS

1. **Stripe Connect** : Chaque restaurant a SON compte Stripe. L'argent va directement chez lui, SpeedAI ne touche jamais les fonds.

2. **S√©curit√© webhook** : Toujours v√©rifier la signature Stripe.

3. **Config dynamique** : Tout changement dans le dashboard s'applique imm√©diatement aux nouvelles r√©servations.

4. **Statuts session** :
   - `pending` : CB demand√©e, pas encore valid√©e
   - `validated` : CB enregistr√©e, r√©sa confirm√©e
   - `completed` : Client venu
   - `cancelled` : R√©sa annul√©e
   - `noshow_charged` : No-show, d√©bit r√©ussi
   - `noshow_failed` : No-show, d√©bit √©chou√©

5. **Pas de Calendar ici** : La cr√©ation de l'√©v√©nement Google Calendar est g√©r√©e par N8N apr√®s validation CB.

---

## R√âSUM√â DES FICHIERS √Ä CR√âER

```
/routes/guarantee.js          # Tous les endpoints API
/components/guarantee/
  ‚îú‚îÄ‚îÄ GuaranteeSettings.jsx   # Page config
  ‚îú‚îÄ‚îÄ GuaranteeReservations.jsx # Liste r√©sas
  ‚îú‚îÄ‚îÄ GuaranteeHistory.jsx    # Historique
  ‚îî‚îÄ‚îÄ GuaranteePage.jsx       # Page client final
```

Commence par cr√©er les tables SQL, puis les endpoints API, puis les composants React. Assure-toi que tout compile sans erreur avant de passer √† la suite.